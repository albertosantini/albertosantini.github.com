<!DOCTYPE html>

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Team4545 Scheduled Games</title>

<style>
    body { font-family: courier, arial, serif; font-size: 10pt; }

    .division { display: inline-block; width: 119px; }
    .round { display: inline-block; width: 20px; }
    .when { display: inline-block; width: 170px; font-weight: bold; }
    .whenLocal { display: inline-block; width: 170px; color: blue; }
    .whiteTeam { display: inline-block; width: 195px; }
    .whitePlayer { display: inline-block; width: 119px; }
    .blackPlayer { display: inline-block; width: 119px; }
    .blackTeam { display: inline-block; width: 195px; }
    .board { display: inline-block; width: 21px; }

    .place { display: inline-block; width: 67px; font-weight: bold; }
    .team { display: inline-block; width: 369px; font-weight: bold; }
    .mp { display: inline-block; width: 53px; }
    .gp { display: inline-block; width: 53px; }
    .forfeits { display: inline-block; width: 19px; }
    .r1 { display: inline-block; width: 88px; }
    .r2 { display: inline-block; width: 88px; }
    .r3 { display: inline-block; width: 88px; }
    .r4 { display: inline-block; width: 88px; }
    .r5 { display: inline-block; width: 88px; }
    .r6 { display: inline-block; width: 88px; }

    .highlight { color: red; }
</style>
</head>

<body>
    <h1>Team4545 - RedDeMate Family</h1> 
    
    <h2>Scheduled Games</h2>
	<div id="games">
	</div>

    <h2>Standings</h2>
	<div id="standings">
	</div>

<script src="http://yui.yahooapis.com/3.3.0/build/yui/yui-min.js"></script> 

<script type="text/javascript">
/*global YUI */

YUI().use("node", "yql", "datatype-date", function (Y) {
    var gamesUrl = "http://team4545league.org/tournament/games.html",
        teamName = 'RedDeMate',
        games = Y.one("#games"),
        standings = Y.one("#standings");

    function formatDate(date) {
        var edtNY = { // EDT periods for NY, otherwise EST, (Mar - Nov)
                2011: { "start": "031302:00", "end": "110602:00"},
                2012: { "start": "031102:00", "end": "110402:00"},
                2013: { "start": "031002:00", "end": "110302:00"},
                2014: { "start": "030902:00", "end": "110202:00"},
                2015: { "start": "030802:00", "end": "110102:00"},
                2016: { "start": "031302:00", "end": "110602:00"},
                2017: { "start": "031202:00", "end": "110502:00"},
                2018: { "start": "031102:00", "end": "110402:00"},
                2019: { "start": "031002:00", "end": "110302:00"}
            },
            win = Y.config.win,
            lang = win.navigator.userLanguage || win.navigator.language,
            intl = Y.DataType.Date.Locale.hasOwnProperty(lang) ? lang : "en-US",
            now = new Date(),
            yyyy = now.getFullYear(),
            sp = date.split(", "),
            www = sp[0],
            mmmddd = sp[1].split(" "),
            mmm = mmmddd[0],
            ddd = mmmddd[1],
            hhh = sp[2],
            mm = Y.DataType.Date.Locale[intl].b.indexOf(mmm) + 1,
            mdh = (mm < 10 ? "0" + mm : mm) + ddd + hhh,
            tz,
            ld;

        if (edtNY.hasOwnProperty(yyyy)) {
            if (mdh >= edtNY[yyyy].start && mdh < edtNY[yyyy].end) {
                tz = "EDT";
            } else {
                tz = "EST";
            }
        } else {
            if (mm >= 3 && mm <= 11) {
                tz = "EDT";
            } else {
                tz = "EST";
            }
        }

        ld = new Date(www + ", " + ddd + " " + mmm + " " + yyyy + 
            " " + hhh + ":00 " + tz);

        return Y.DataType.Date.format(ld, {format: "%a, %b %d, %H:%M"});
    }

    function myStandings(results) {
        var node, container = "", found = false;

        if (results.results.length === 0) {
            standings.setContent("Problems to retrieve team4545 info.");
            return;
        }

        container = "<span class='place'>" + "Place" + "<\/span>" +
            "<span class='team'>" + "Team" + "<\/span>" +
            "<span class='mp'>" + "MP" + "<\/span>" +
            "<span class='gp'>" + "GP" + "<\/span>" +
            "<span class='forfeits'>" + "F" + "<\/span>" +
            "<span class='r1'>" + "R1" + "<\/span>" +
            "<span class='r2'>" + "R2" + "<\/span>" +
            "<span class='r3'>" + "R3" + "<\/span>" +
            "<span class='r4'>" + "R4" + "<\/span>" +
            "<span class='r5'>" + "R5" + "<\/span>" +
            "<span class='r6'>" + "R6" + "<\/span>" + "<br /><br />";

        node = Y.Node.create(results.results[0]);

        node.all("table.stand tr").each(function (el) {
            var cols = el.all("td p"), 
                place,
                team,
                mp,
                gp,
                forfeits,
                r1,
                r2,
                r3,
                r4,
                r5,
                r6,
                isOurTeam;

            if (cols.size() < 10) {
                return;
            }

            place = (cols.item(0) && cols.item(0).getContent()) || "";
            team = (cols.item(1) && cols.item(1).getContent()) || "";
            mp = (cols.item(2) && cols.item(2).getContent()) || "";
            gp = ((cols.item(3) && cols.item(3).getContent()) || "")
                .replace(/&nbsp;/gi,'');
            forfeits = (cols.item(4) && cols.item(4).getContent()) || "";
            r1 = (cols.item(5) && cols.item(5).getContent()) || "";
            r2 = (cols.item(6) && cols.item(6).getContent()) || "";
            r3 = (cols.item(7) && cols.item(7).getContent()) || "";
            r4 = (cols.item(8) && cols.item(8).getContent()) || "";
            r5 = (cols.item(9) && cols.item(9).getContent()) || "";
            r6 = (cols.item(10) && cols.item(10).getContent()) || "";

            isOurTeam = team.search(teamName) !== -1;

            if (!isOurTeam) {
                return;
            }

            found = true;

            container += "<span class='place'>" + place + "<\/span>" +
                "<span class='team'>" + team + "<\/span>" +
                "<span class='mp'>" + mp + "<\/span>" +
                "<span class='gp'>" + gp + "<\/span>" +
                "<span class='forfeits'>" + forfeits + "<\/span>" +
                "<span class='r1'>" + r1 + "<\/span>" +
                "<span class='r2'>" + r2 + "<\/span>" +
                "<span class='r3'>" + r3 + "<\/span>" +
                "<span class='r4'>" + r4 + "<\/span>" +
                "<span class='r5'>" + r5 + "<\/span>" +
                "<span class='r6'>" + r6 + "<\/span>" + "<br />";
        });

        if (found) {
            standings.setContent(container);
        } else {
            standings.setContent("There are not standings yet.");
        }
    }

    function myGames(results) {
        var node, container, found = false, tourney, standingsUrl;

        if (results.results.length === 0) {
            games.setContent("Problems to retrieve team4545 info.");
            return;
        }

        node = Y.Node.create(results.results[0]);

        tourney = node.all("h3").get("text")[0].split("- ")[1].split(" ")[0]
            .toLowerCase();
        standingsUrl = "http://team4545league.org/tournament/" + tourney +
            "/" + tourney + "standing.html";

        Y.YQL('select * from html where url="' + standingsUrl + '"', 
            myStandings, { format: 'xml' });

        container = "<span class='when'>" + "When ICC" + "<\/span>" +
            "<span class='whenLocal'>" + "When Local" + "<\/span>" +
            "<span class='division'>" + "Division" + "<\/span>" +
            "<span class='round'>" + "R" + "<\/span>" +
            "<span class='whiteTeam'>" + "White Team" + "<\/span>" +
            "<span class='whitePlayer'>" + "White Player" + "<\/span>" +
            "<span class='blackPlayer'>" + "Black Player" + "<\/span>" +
            "<span class='blackTeam'>" + "Black Team" + "<\/span>" +
            "<span class='board'>" + "B" + "<\/span>" + "<br /><br />";

        node.all("tr").each(function (el) {
            var cols = el.all("td p"), 
                division,
                round,
                when,
                whenLocal,
                whiteTeam,
                whitePlayer,
                blackPlayer,
                blackTeam,
                board,
                isOurTeam;

            if (cols.size() === 0) {
                return;
            }

            division = Y.Node.create(cols.item(0).getContent()).get("text")
                .replace(/\s{2,}/g, ' ');
            round = cols.item(1).getContent();
            when = cols.item(2).getContent();
            whenLocal = formatDate(when);
            whiteTeam = cols.item(3).getContent();
            whitePlayer = cols.item(4).getContent();
            if (cols.size() === 9) {
                blackPlayer = cols.item(6).getContent();
                blackTeam = cols.item(7).getContent();
                board = cols.item(8).getContent();
            } else {
                blackPlayer = cols.item(5).getContent();
                blackTeam = cols.item(6).getContent();
                board = cols.item(7).getContent();
            }

            isOurTeam = whiteTeam.search(teamName) !== -1 || 
                blackTeam.search(teamName) !== -1;

            if (!isOurTeam) {
                return;
            }

            found = true;

            container += "<span class='when'>" + when + "<\/span>" +
                "<span class='whenLocal'>" + whenLocal + "<\/span>" +
                "<span class='division'>" + division + "<\/span>" +
                "<span class='round'>" + round + "<\/span>" +
                "<span class='whiteTeam'>" + whiteTeam + "<\/span>";
            if (whiteTeam.search(teamName) !== -1) {
                container += "<span class='whitePlayer highlight'>" + 
                    whitePlayer + "<\/span>";
            } else {
                container += "<span class='whitePlayer'>" +
                    whitePlayer + "<\/span>";
            }
            if (blackTeam.search(teamName) !== -1) {
                container += "<span class='blackPlayer highlight'>" + 
                    blackPlayer + "<\/span>";
            } else {
                container += "<span class='blackPlayer'>" + 
                    blackPlayer + "<\/span>";
            }
            container += "<span class='blackTeam'>" + 
                blackTeam + "<\/span>" +
                "<span class='board'>" + 
                board + "<\/span>" + "<br />";
        });

        if (found) {
            games.setContent(container);
        } else {
            games.setContent("Games not scheduled yet.");
        }
    }

    Y.YQL('select * from html where url="' + gamesUrl + '"', myGames,
        { format: 'xml' });
});

</script>
</body>
</html>


