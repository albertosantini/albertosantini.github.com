<!DOCTYPE html>

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Test Tragitto</title>
</head>

<body>

<h1>Test Tragitto</h1>
<p>
Quanto tempo impiego ad arrivare a destinazione?
Quanto tempo aspetto alla coincidenza?
</p>

<div id="results"></div>

<p>
In questo prototipo le informazioni, che descrivono i tempi di attesa ed il 
grafo del tragitto, sono dati. 
Nel caso di un integrazione all'interno di MuoviMi, ad esempio, il tempo di 
attesa della fermata dovrebbe essere recuperato online, ma soltanto quando e'
necessario.
Il grafo del tragitto sarebbe calcolato utilizzando uno dei noti algoritmi di
ricerca (breadth first, depth firt, A*, etc.), partendo dalla lista delle
linee e le fermate corrispondenti. Il grafo, comunque, potrebbe essere precalcolato.
</p>
<p>
L'algoritmo prevede due funzioni: calcolaTempoPerTratta e calcolaAttesaAllaCoincidenza.
</p>
<p>
calcolaTempoPerTratta calcola il tempo di percorrenza fra una fermata iniziale
ed una finale: fermata per fermata interroga il tempo di attesa e, virtualmente,
saltando da un mezzo all'altro viene calcolato il tempo totale. Supponiamo
che siamo alle fermata F con tempo di attesa 4 minuti. Cominciamo a procedere
in avanti sulla tratta, fermata per fermata. F+1, attesa 6 minuti. F+2, attesa
10 minuti. F+3, attesa 2 minuti. Quando il tempo di attesa torna a scendere,
vuol dire che un mezzo, che precede quello attuale, si sta avvicinando a quella
fermata. Il tempo di percorrenza totale e' la somma della massima attesa per ogni mezzo.
Quindi da F a F+3, il tempo di percorrenza e' 12 minuti.
</p>
<p>
calcolaAttesaAllaCoincidenza calcola l'attesa alla fermata di coincidenza, 
dando come vincolo il tempo previsto di arrivo a quella fermata. 
Supponiamo che siamo alla fermata F con tempo di attesa 5 minuti. Cominciamo a
procedere all'indietro sulla tratta, fermata per fermata. F-1, attesa 3 minuti.
F-2, attesa 1 minuto. F-3, attesa 10 e cosi' via. Quando il tempo di attesa 
torna a salire, vuol dire che un mezzo, che insegue quello attuale, si sta
avvicinando a quella fermata. Quindi se si arrivasse alla fermata F in 2 minuti,
bisognerebbe aspettare 3 minuti. Se si arrivasse in 12 minuti, si aspetterebbero
3 minuti (F, 5 minuti + F-3, 10 minuti = 15 minuti - 12 minuti = 3 minuti).
E' come se si calcolasse il tempo di percorrenza della tratta all'indietro, il
cui vincolo non e' una fermata di arrivo, ma il tempo previsto di arrivo alla
fermata di coincidenza. Se risultasse un tempo di attesa negativo, vuol dire 
che non ci sono mezzi disponibili sulla tratta che possono raggiungere quella
fermata prima che l'utente ci arrivi: bisognerebbe prevedere un refresh del
calcolo del tragitto.
</p>
<p>
Per quanto riguarda l'interfaccia utente si potrebbero avere diverse fasi:
la prima, la piu' semplice, prevede di costruire il tragitto aggiungendo 
manualmente la fermata di partenza, quella di arrivo e le coincidenze. Quindi 
non sarebbe necessario un algoritmo di ricerca che definisca un tragitto. Una
seconda fase potrebbe, invece, prevedere la definizione del tragitto in modo
automatico, inserendo la fermata di partenza e quella di arrivo. Una terza fase,
la piu' complicata, prevederebbe di dare la possibilita' all'utente di selezionare
le fermate dalla mappa, anziche' ricercarle testualmente come nella seconda fase.
</p>


<script src="http://yui.yahooapis.com/3.3.0/build/yui/yui-min.js"></script> 
<script>
/*global YUI */

YUI().use("node", function (Y) {
    // Non ho aggiunto le descrizioni delle fermate
    var linea7 = [
        { fermata: "", attesa: 1 }, // mezzo 1
        { fermata: "", attesa: 4 },
        { fermata: "", attesa: 6 },
        { fermata: "", attesa: 8 },
        { fermata: "", attesa: 12 },
        { fermata: "", attesa: 3 }, // mezzo 2
        { fermata: "", attesa: 6 },
        { fermata: "", attesa: 8 }, // fermata di partenza
        { fermata: "", attesa: 13 },
        { fermata: "", attesa: 15 },
        { fermata: "", attesa: 3 }, // mezzo 3
        { fermata: "", attesa: 4 }, // fermata di coincidenza
        { fermata: "", attesa: 7 },
        { fermata: "", attesa: 11 }
    ],
    linea2 = [
        { fermata: "", attesa: 11 }, // mezzo 1
        { fermata: "", attesa: 14 },
        { fermata: "", attesa: 3 }, // mezzo 2
        { fermata: "", attesa: 7 },
        { fermata: "", attesa: 10 },
        { fermata: "", attesa: 15 },
        { fermata: "", attesa: 2 }, // mezzo 3
        { fermata: "", attesa: 5 }, // fermata di coincidenza 1
        { fermata: "", attesa: 9 },
        { fermata: "", attesa: 11 },
        { fermata: "", attesa: 2 }, // fermata di coincidenza 2 // mezzo 4
        { fermata: "", attesa: 6 },
        { fermata: "", attesa: 8 },
        { fermata: "", attesa: 13 }
    ],
    linea12 = [
        { fermata: "", attesa: 11 }, // mezzo 1
        { fermata: "", attesa: 14 },
        { fermata: "", attesa: 3 }, // mezzo 2
        { fermata: "", attesa: 7 },
        { fermata: "", attesa: 10 },
        { fermata: "", attesa: 15 },
        { fermata: "", attesa: 2 }, // mezzo 3
        { fermata: "", attesa: 5 }, // fermata di coincidenza
        { fermata: "", attesa: 9 },
        { fermata: "", attesa: 11 },
        { fermata: "", attesa: 2 }, // fermata di arrivo // mezzo 4
        { fermata: "", attesa: 6 },
        { fermata: "", attesa: 8 },
        { fermata: "", attesa: 13 }
    ],
    tragitto = [
        { linea: linea7, start: 7, end: 11 },
        { linea: linea2, start: 7, end: 10 },
        { linea: linea12, start: 7, end: 10 }
    ],
    i, t = tragitto.length, linea, start, end, 
    tempoPercorrenza = 0, attesaCoincidenza = 0;


    // Calcola il tempo di percorrenza di una tratta:
    //
    // Per esempio:
    // - da partenza a coincidenza 
    // - da coincidenza a coincidenza
    // - da coincidenza a destinazione
    // 
    // La funzione percorre dalla fermata start alla fermata end, una fermata
    // alla volta, accumulando i tempi di attesa dei mezzi che stanno
    // percorrendo la tratta.
    function calcolaTempoPerTratta(linea, start, end) {
        var i, attesaMezzo = 0, tempo = 0;

        for (i = start + 1; i <= end; i += 1) {
            if (linea[i].attesa >= linea[i - 1].attesa) { // stesso mezzo
                attesaMezzo = linea[i].attesa;
            } else { // cambio virtuale del mezzo
                if (i === end) {
                    tempo += linea[i].attesa;
                } else {
                    tempo += attesaMezzo;
                }
            }
        }
        tempo += attesaMezzo;

        Y.one("#results").append("tempo di arrivo fino alla fermata: " 
            + tempo + "<br />");

        return tempo;
    }

    // Calcola il tempo di attesa alla coincidenza dato il tempo di arrivo 
    //
    // La funzione percorre da start all'indietro, una fermata alla volta,
    // accumulando i tempi di attesa dei mezzi che stanno percorrendo 
    // la tratta, fino a quando l'attesa non e' maggiore del tempo di 
    // percorrenza (eta) necessario per arrivare a quella coincidenza.
    function calcolaAttesaAllaCoincidenza(linea, start, eta) {
        var i = start, attesaMezzo = 0, attesa = 0;

        while (i >= 1 && attesa <= eta) {
            if (linea[i].attesa >= linea[i - 1].attesa) { // stesso mezzo
                attesaMezzo = Math.max(attesaMezzo, linea[i].attesa);
            } else { // cambio virtuale del mezzo
                attesa += attesaMezzo;
                attesaMezzo = 0;
            }
            i -= 1;
        }
        attesa += attesaMezzo;

        Y.one("#results").append("tempo di attesa alla coincidenza: " 
            + (attesa - eta) + "<br />");

        return attesa - eta;
    }

    //
    // Loop principale
    //
    for (i = 0; i < t; i += 1) {
        linea = tragitto[i].linea;
        start = tragitto[i].start;
        end = tragitto[i].end;

        if (i === 0) { // prima tratta fino alla coincidenza
            Y.one("#results").append("tempo di attesa alla partenza: " 
                + linea[start].attesa + "<br />");
            tempoPercorrenza = calcolaTempoPerTratta(linea, start, end);
        } else { // successive tratte dopo la prima coincidenza
            attesaCoincidenza = calcolaAttesaAllaCoincidenza(linea, start, 
                tempoPercorrenza);
            tempoPercorrenza += attesaCoincidenza;
            tempoPercorrenza += calcolaTempoPerTratta(linea, start, end);
        }
    }

    Y.one("#results").append("tempo di percorrenza fino a destinazione: "
        + tempoPercorrenza + "<br />");
});
</script>

</body>
</html>

